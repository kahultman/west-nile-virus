---
title: "WNV Project"
author: "Keith Hultman"
date: "12/4/2016"
output:
  pdf_document:
    toc_depth: '2'
  html_document:
    TOC: yes
    code_folding: hide
    fig_caption: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../')
```

# West Nile Virus Prediction

This project will attempt to predict the likelihood of a positive test for West Nile Virus in mosquitos captured using traps around Chicago, IL. The data sets originate from the Kaggle competition, [West Nile Virus Prediction](https://www.kaggle.com/c/predict-west-nile-virus). 

This analysis will use an iterative approach to finding a production model for West Nile forecasting. There are several data science iterative methods, and I will use the [CRISP](./images/CRISP.png) model for organizing this project. 

# CRISP Iteration 1

## Business Understanding 

Kaggle supplies five data sets for the competition, three of which can be used in model training. The train.csv file includes several variables associated with each West Nile Virus test including the trap id, geo-coordinates, date, species of mosquito present, number of mosquitos present, and a binary variable indicating the presence or absence of West Nile Virus (WnvPresent), our target variable. The test.csv contains all of the same features as the train.csv file except the number of mosquitos present and the target WnvPresent variable. These data sets were obtained from West Nile Virus testing period between 2007 and 2014 with the training set containing the odd years and the test set containing the even years. The weather.csv file contains historic weather data collected at the O'Hare and Midway airports concurrent with the mosquito testing time period. The spray.csv file includes the date and location of chemical spraying conducted by the city during 2011 and 2013. Since this spray data set would only have a large impact during one of the training years, I did not include the spray data in any of my models. 

## Data Understanding 

One of the largest factors in whether West Nile Virus is present or not is the number of mosquitos found in each trap. However, this variable is not present in the test set, and will need to be imputed from other variables before a final model can be fit to the presence of West Nile. 

```{r}
suppressMessages(library(tidyverse))
load("./data/train.RData")
load("./data/test.RData")

ggplot(train, aes(x=WnvPresent, y=NumMosquitos)) + geom_boxplot() + ggtitle("Number of mosquitos in West Nile Virus negative and positive traps") + xlab("West Nile Virus present in trap") + ylab("Number of mosquitos in trap")
```

Based on this initial data exploration, I will first try and develop a model that predicts the number of mosquitos in each trap and then use that predicted value as a variable in a model that predicts whether West Nile is present or absent. For predicting the number of mosquitos, I will primarily be using weather variables and weekly historic averages. 

```{r}
ggplot(train, aes(x=Tavg, y=NumMosquitos)) + geom_jitter() + geom_smooth(method=lm) + ggtitle("Number of mosquitos vs average daily temperature") + xlab("Average daily temperature, degree F") + ylab("Number of mosquitos per trap")

```




## Data Preparation 



## Modeling 1a: Linear regression to predict mosquito population

For this first round of modeling, I will use linear regression to predict the number of mosquitos using weather data and historical averages per week. I expect that higher average temperatures and greater moisture should have a positive effect on the mosquito population.

Then I will use logistic regression to estimate the probability of the presence of West Nile Virus. 

```{r}
weathervariables <- c("Tmax", 
                      "Tmin",
                      "Tavg",
                      "DewPoint",
                      "WetBulb",
                      "Sunrise",
                      "Sunset",
                      "PrecipTotal",
                      "ResultSpeed",
                      "ma3",
                      "ma5",
                      "ma10",
                      "precip3d",
                      "precip5d",
                      "precip10d")

weathervariables <- paste(weathervariables, collapse = "+")
fmla <- paste("NumMosquitos", weathervariables, sep = "~")

lm1 <- lm(fmla, data = train)
train$lmNumMosq <- predict(lm1, newdata = train)
test$lmNumMosq <- predict(lm1, newdata = test)
summary(lm1)
```

## Plot residuals

From now on, all graphs will show performance on test data. 

```{r lm1 residual plot}
ggplot(data = train, aes(x=lmNumMosq, y=(NumMosquitos - lmNumMosq))) + geom_point(alpha = 0.05)
```


Target variable distribution

```{r}
table(train$WnvPresent)

qqnorm(train$NumMosquitos)
hist(train$NumMosquitos)

hist(log2(train$NumMosquitos))
```

Absolute number of mosquitos might not be an accurate variable. 

```{r}
train$NumMosQuartile <- with(train, cut(NumMosquitos, breaks=quantile(NumMosquitos, probs=seq(0,1, by=0.25), na.rm=TRUE), include.lowest=TRUE))

```


## Modeling 1b: Logistic regression to predict WNV infection

```{r}
lgm1 <- glm(WnvPresent ~ NumMosQuartile + precip10d + ma10 + Tmin + Summer + Year, data = train, family = binomial(link = "logit"))
train$Wnv.glm.Pred <- predict(lgm1, newdata = train, type = "response")
test$NumMosquitos <- test$lmNumMosq
test$Wnv.glm.Pred <- predict(lgm1, newdata = test, type = "response")
summary(lgm1)


```

## Evaluation 

Now we can take a look at how well our model will perform based on where the cutoff for probability should be for predicting WnvPresent.
```{r}
suppressMessages(library(ROCR))
suppressMessages(library(pROC))

pred <- prediction(train$Wnv.glm.Pred, train$WnvPresent)
perf <- performance(pred, "tpr", "fpr")

plot(perf)

auc(train$WnvPresent, train$Wnv.glm.Pred)
```

The AUC for the test set, after submitting the predicted probabilities to Kaggle was 0.696. Since this is much lower than the 0.814 AUC from the training set, this model is likely overfit to the training set. 

# CRISP Iteration 2

The logistic regression model might be improved with using a boosting algorithm
 
```{r}
suppressMessages(library(caret))

set.seed(300)
ctrl <- trainControl(method = "repeatedcv", 
                     number = 10, 
                     repeats = 3,
                     classProbs = TRUE, 
                     summaryFunction = twoClassSummary)

glmboost <- train(WnvPresent ~ NumMosquitos + precip10d + ma10 + Tmin + Summer + Year,
              data = train, 
              method = "glmboost",
              metric = "ROC",
              trControl = ctrl,
              tuneLength = 5,
              center = TRUE,
              family = Binomial(link = c("logit")))


ctrl <- trainControl(method = "repeatedcv", number = 10, savePredictions = TRUE)

lgm2 <- train(WnvPresent ~ NumMosquitos + precip10d + ma10 + Tmin + Summer + Year,  data=train, method="glm", family="binomial",
                 trControl = ctrl, tuneLength = 5)

train2 <- select(train, WnvPresent, NumMosquitos, precip10d, ma10, Tmin, Summer, Year)
summary(train2)
fitControl <- trainControl(method = "repeatedcv",
                           number = 5,
                           repeats = 10,
                           ## Estimate class probabilities
                           classProbs = TRUE,
                           ## Evaluate performance using 
                           ## the following function
                           summaryFunction = twoClassSummary)

set.seed(2014)

glmBoostModel <- train(WnvPresent ~ ., data=train2, method = "glmboost", metric="ROC", trControl = fitControl, tuneLength=5, center=TRUE, family=Binomial(link = c("logit")))

```

## Data Understanding 2

The first model did not involve geographical information or any trap-specific information. Let's examine the relationship between geography and West Nile presence. First let's look at a map of Wnv as a density plot. Here, the density is based off of the overall positive count for each trap. 

 

```{r}
library(ggmap)
chicago <- get_map("Chicago")
wnpositive <- filter(train, WnvPresent == TRUE)
load("./data/traps.RData")

ggmap(chicago) + geom_density2d(data = wnpositive, aes(x = Longitude, y = Latitude), size = 0.3) + 
  stat_density2d(data = wnpositive, aes(x = Longitude, y = Latitude, fill = ..level.., alpha = ..level..), size = 0.01, 
    bins = 16, geom = "polygon") + 
  scale_fill_gradient(name="Number of WNV+", low = "green", high = "red") + 
  scale_alpha(range = c(0, 0.3), guide = FALSE) + 
  ggtitle("Heat map of West Nile Virus positive traps") + 
  xlab("Longitude") + ylab("Latitude") +
  geom_point(data = traps, aes(x = Longitude, y = Latitude), shape = 4)
```
(the total positive count of a trap divided by the total number of times that trap was tested). 


I next wanted to get a sense of how this pattern of West Nile Virus changed over time in relation to the geography, so I created an animated version of this map. I removed the background to get a clearer visual of positive vs negative cases. Animating the map requires too much time to rebuild in the document, but the code can be found in the src folder called "07_animated_map.R"

![Animated map (not available in PDF document)](../images/mosq_map.gif)

After seeing how highly varied the density of WnvPresent traps were in the heat map and animated plots, my next set of models will try to incorporate geographic information. 

There are various ways to incorporate geography. The easiest way to do this is to incorporate the trap id in the model. A more elegant method would incorporate the longitude and latitude. The longitude/latitude method would require a decision tree or other model that allows for breaking up or clustering the locations in some way. 

The will try to use the first method in a logistic regression model. 

## Data Preparation 2

Add clustering regions

```{r}
trap_geo_hot <- train %>% group_by(Trap, Longitude, Latitude) %>% 
  summarise(number = n(), WnvTot = sum(WnvPresent)) %>% 
  mutate(WnvAvg = WnvTot/number) %>% 
  select(Trap, Latitude, Longitude, WnvAvg) %>% 
  arrange(Trap)

# Geographic + Hotspot clusters using k-means with k=6
set.seed(123)
geo.hot.cl <- kmeans(trap_geo_hot[,2:4], centers = 6)
trap_geo_hot$geo.hot.cl <- as.factor(geo.hot.cl$cluster)

# Add Geographic hotspot clusters to trainset
train <- left_join(train, trap_geo_hot, by = c("Trap", "Longitude", "Latitude"))

ggplot(trap_geo_hot, aes(Longitude, Latitude, color = geo.hot.cl)) + geom_point()

ggmap(chicago) + geom_density2d(data = wnpositive, aes(x = Longitude, y = Latitude), size = 0.3) + 
  stat_density2d(data = wnpositive, aes(x = Longitude, y = Latitude, fill = ..level.., alpha = ..level..), size = 0.01, 
    bins = 16, geom = "polygon") + 
  scale_fill_gradient(name="Number of WNV+", low = "green", high = "red") + 
  scale_alpha(range = c(0, 0.3), guide = FALSE) + 
  ggtitle("Heat map of West Nile Virus positive traps") + 
  xlab("Longitude") + ylab("Latitude") +
  geom_point(data = trap_geo_hot, aes(x = Longitude, y = Latitude, shape = geo.hot.cl)) + scale_shape_discrete(name = "Trap Cluster")

```


## Modeling 2a: Decision Tree

```{r}

```


## Modeling 3b: 


## Evaluation 1


# Deployment

